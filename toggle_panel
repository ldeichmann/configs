#!/bin/bash

screenname="panelscreen"

is_panel_running ()
{
    if screen -list | grep -q $screenname ; then
        return 0
    else
        return 1
    fi
}

start ()
{
    if ! is_panel_running ; then
        printf "%s\n" "Starting panel"
        bash -c "cd ~/.config/panel/ && screen -dmS $screenname ./panel"

        # move lower when fullscreen
        wid=$(xdo id -a "$PANEL_TOP_WM_NAME")
        tries_left=20
        while [ -z "$wid" ] && [ "$tries_left" -gt 0 ] ; do
            sleep 0.05
            wid=$(xdo id -a "$PANEL_TOP_WM_NAME")
            tries_left=$((tries_left - 1))
        done
        for w in $wid; do
            [ -n "$w" ] && xdo above -t "$(xdo id -N Bspwm -n root | sort | head -n 1)" "$w"
        done
    fi

}

stop ()
{
    printf "%s\n" "Stopping panel"
    screen -X -S $screenname kill
}

toggle ()
{
    if ! is_panel_running ; then
        start
    else
        stop
    fi
}

if [ -n "$1" ] ; then
    if [ "$1" = "start" ] ; then
        start
    elif [ "$1" = "stop" ] ; then
        stop
    elif [ "$1" = "restart" ] ; then
        stop;
        start;
    fi
else
    toggle
fi
